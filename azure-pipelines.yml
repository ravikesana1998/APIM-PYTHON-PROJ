trigger:
- main

variables:
  dockerRegistryServiceConnection: '99c0a625-5f02-4515-b601-ee6f0455d046'  # Azure Container Registry connection
  imageRepository: 'pythonrreg'                                            # Must be lowercase
  containerRegistry: 'pythonrreg.azurecr.io'                               # ACR login server
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  imageNameWithTag: '$(containerRegistry)/$(imageRepository):$(tag)'
  imageNameLatest: '$(containerRegistry)/$(imageRepository):latest'

pool:
  name: 'self-hosted-pool'

# ------------------ Stage 1: BUILD ------------------
stages:
- stage: Build
  displayName: 'Docker Build'
  jobs:
  - job: BuildImage
    displayName: 'Build Docker Image'
    steps:
    - script: |
        echo "##[group]Build Image"
        echo "Building Docker image: $(imageNameWithTag)"
        docker build -t $(imageNameWithTag) -t $(imageNameLatest) -f $(dockerfilePath) .
        echo "##[endgroup]"
      displayName: 'Build Docker Image'

# ------------------ Stage 2: PUSH ------------------
- stage: Push
  displayName: 'Push to ACR'
  dependsOn: Build
  jobs:
  - job: PushImage
    displayName: 'Push Docker Image to ACR'
    steps:
    - task: Docker@2
      displayName: 'Login to Azure Container Registry'
      inputs:
        command: login
        containerRegistry: $(dockerRegistryServiceConnection)

    - script: |
        echo "##[group]Pushing Images"
        echo "Pushing Docker image with tag: $(imageNameWithTag)"
        docker push $(imageNameWithTag)
        echo "Pushing Docker image with tag: $(imageNameLatest)"
        docker push $(imageNameLatest)
        echo "##[endgroup]"
      displayName: 'Push Docker Image to ACR'
